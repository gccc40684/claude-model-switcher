#!/bin/bash

# Claude Model Switcher - Quick Switch Script
# Usage: claude <model_name> [-e]

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if [ $# -eq 0 ]; then
    node "$SCRIPT_DIR/src/index.js" help
    exit 0
fi

MODEL_NAME="$1"
EDIT_FLAG=""

# Check for edit flag
if [ "$2" = "-e" ] || [ "$2" = "--edit" ]; then
    EDIT_FLAG="-e"
fi

case "$MODEL_NAME" in
    "claude"|"gemini"|"deepseek"|"qwen"|"kimi"|"glm"|"ollama")
        if [ -n "$EDIT_FLAG" ]; then
            echo "üîß Editing configuration for $MODEL_NAME..."
            node "$SCRIPT_DIR/src/index.js" "$MODEL_NAME" "$EDIT_FLAG"
        else
            echo "üîÑ Switching to $MODEL_NAME..."
            node "$SCRIPT_DIR/src/index.js" "$MODEL_NAME"

            # Apply environment variables to current shell session
            ENV_FILE="$HOME/.claude-model-switcher/current-env.sh"
            if [ -f "$ENV_FILE" ]; then
                echo "üìù Applying environment variables to current session..."
                source "$ENV_FILE"
                echo "‚úÖ Environment variables applied"
                echo "üöÄ Claude Code is now using $MODEL_NAME"

                # Display current environment status
                echo "üìä Current configuration:"
                echo "   ANTHROPIC_BASE_URL: $ANTHROPIC_BASE_URL"
                if [ -n "$ANTHROPIC_API_KEY" ]; then
                    echo "   ANTHROPIC_API_KEY: ***${ANTHROPIC_API_KEY: -4}"
                fi

                echo ""
                echo "üéØ For this terminal: Environment is ready!"
                echo "üí° For new terminals: Please run 'source ~/.zshrc' or open a new terminal"
                echo ""
                echo "‚ñ∂Ô∏è  Run 'claude' to start Claude Code with $MODEL_NAME"
            else
                echo "‚ö†Ô∏è  Environment file not found, please try again"
            fi
        fi
        ;;
    "list"|"ls")
        node "$SCRIPT_DIR/src/index.js" list
        ;;
    "custom")
        node "$SCRIPT_DIR/src/index.js" custom
        ;;
    "delete")
        if [ -z "$2" ]; then
            echo "‚ùå Please specify a model to delete"
            echo "Usage: claude delete <model-name>"
            exit 1
        fi
        node "$SCRIPT_DIR/src/index.js" delete "$2"
        ;;
    "current"|"c")
        node "$SCRIPT_DIR/src/index.js" current
        ;;
    "help"|"h"|"--help")
        node "$SCRIPT_DIR/src/index.js" help
        ;;
    "web"|"ui"|"--web")
        echo "üöÄ Starting Claude Model Switcher Web UI..."
        echo "üì± Opening H5 interface at http://localhost:3000"
        echo ""
        node "$SCRIPT_DIR/web-start.js"
        ;;
    *)
        if [ -n "$EDIT_FLAG" ]; then
            echo "üîß Editing configuration for $MODEL_NAME..."
            node "$SCRIPT_DIR/src/index.js" "$MODEL_NAME" "$EDIT_FLAG"
        else
            echo "üîÑ Attempting to switch to $MODEL_NAME..."
            node "$SCRIPT_DIR/src/index.js" "$MODEL_NAME"

            # Apply environment variables if switch was successful
            ENV_FILE="$HOME/.claude-model-switcher/current-env.sh"
            if [ -f "$ENV_FILE" ]; then
                echo "üìù Applying environment variables to current session..."
                source "$ENV_FILE"
                echo "‚úÖ Environment variables applied"
                echo "üöÄ Claude Code is now using $MODEL_NAME"

                # Display current environment status
                echo "üìä Current configuration:"
                echo "   ANTHROPIC_BASE_URL: $ANTHROPIC_BASE_URL"
                if [ -n "$ANTHROPIC_API_KEY" ]; then
                    echo "   ANTHROPIC_API_KEY: ***${ANTHROPIC_API_KEY: -4}"
                fi

                echo ""
                echo "üéØ For this terminal: Environment is ready!"
                echo "üí° For new terminals: Please run 'source ~/.zshrc' or open a new terminal"
                echo ""
                echo "‚ñ∂Ô∏è  Run 'claude' to start Claude Code with $MODEL_NAME"
            fi
        fi
        ;;
esac